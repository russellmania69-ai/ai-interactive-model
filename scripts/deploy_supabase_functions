#!/usr/bin/env bash
set -euo pipefail

# deploy_supabase_functions
# Usage:
#   deploy_supabase_functions [--set-secrets] [--ref main] [owner repo workflow_filename]
#
# Environment variables used:
#   GITHUB_TOKEN            - Personal access token with repo:workflow or repo scope (required for API fallback)
#   STRIPE_SECRET_KEY       - (optional) stripe secret to set in repo via gh
#   SUPABASE_ACCESS_TOKEN   - (optional) supabase PAT to set in repo via gh
#   SUPABASE_PROJECT_REF    - (optional) project ref to set in repo via gh
#
# Behavior:
#  - If `gh` is available the script will optionally set repository secrets (if --set-secrets)
#    and then run the workflow using `gh workflow run`.
#  - If `gh` is not available the script will attempt to trigger the workflow via the
#    GitHub Actions API using `GITHUB_TOKEN`.

OWNER=${1:-russellmania69-ai}
REPO=${2:-refactored-octo-barnacle}
WORKFLOW_FILE=${3:-deploy-supabase-functions.yml}
REF=${4:-main}

SET_SECRETS=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --set-secrets)
      SET_SECRETS=true; shift ;;
    --ref)
      REF=$2; shift 2 ;;
    --help|-h)
      sed -n '1,120p' "$0"; exit 0 ;;
    *) shift ;;
  esac
done

echo "Deploy helper: owner=$OWNER repo=$REPO workflow=$WORKFLOW_FILE ref=$REF set_secrets=$SET_SECRETS"

run_with_gh() {
  echo "Using gh CLI path: $(command -v gh)"
  if [ "$SET_SECRETS" = true ]; then
    if [ -z "${STRIPE_SECRET_KEY:-}" ] || [ -z "${SUPABASE_ACCESS_TOKEN:-}" ] || [ -z "${SUPABASE_PROJECT_REF:-}" ]; then
      echo "--set-secrets requested but STRIPE_SECRET_KEY, SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_REF is not set in env." >&2
      return 2
    fi

    echo "Setting repository secrets via gh..."
    gh secret set STRIPE_SECRET_KEY --body "$STRIPE_SECRET_KEY" --repo "$OWNER/$REPO"
    gh secret set SUPABASE_ACCESS_TOKEN --body "$SUPABASE_ACCESS_TOKEN" --repo "$OWNER/$REPO"
    gh secret set SUPABASE_PROJECT_REF --body "$SUPABASE_PROJECT_REF" --repo "$OWNER/$REPO"
  fi

  echo "Triggering workflow via gh..."
  gh workflow run "$WORKFLOW_FILE" --repo "$OWNER/$REPO" --ref "$REF"
  echo "Triggered. Use 'gh run list --repo $OWNER/$REPO' to follow runs." 
}

dispatch_with_api() {
  if [ -z "${GITHUB_TOKEN:-}" ]; then
    echo "GITHUB_TOKEN is required for API dispatch fallback and is not set." >&2
    return 2
  fi

  echo "Triggering workflow via GitHub API (no gh available)..."
  API_URL="https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches"

  resp=$(curl -sS -o /dev/stderr -w "%{http_code}" -X POST "$API_URL" \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    -d "{\"ref\": \"$REF\"}")

  if [ "$resp" -eq 204 ]; then
    echo "Workflow dispatch sent (HTTP 204). Check Actions tab for the run.";
  else
    echo "Workflow dispatch API returned HTTP $resp. Check token and workflow filename; see the response above for details." >&2
    return 3
  fi
}

main() {
  if command -v gh >/dev/null 2>&1; then
    run_with_gh || dispatch_with_api
  else
    dispatch_with_api
  fi
}

main
