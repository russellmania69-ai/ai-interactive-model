name: Deploy Supabase Edge Functions

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR (if token provided)
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          if [ -n "$GHCR_TOKEN" ]; then
            echo "Logging in to ghcr.io"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          else
            echo "GHCR_TOKEN not set; skipping GHCR login"
          fi

      - name: Deploy Supabase functions using Dockerized CLI
        env:
          SUPABASE_CLI_IMAGE: ghcr.io/supabase/cli:latest
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          set -euo pipefail
          IMAGE="$SUPABASE_CLI_IMAGE"
          WORKDIR="${{ github.workspace }}"

          echo "Setting Stripe secret (docker image: $IMAGE)"
          docker run --rm -v "$WORKDIR":/work -w /work \
            -e SUPABASE_ACCESS_TOKEN="$SUPABASE_ACCESS_TOKEN" \
            -e SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF" \
            -e STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" \
            $IMAGE supabase secrets set STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" --project-ref "$SUPABASE_PROJECT_REF"

          echo "Deploying create-stripe-checkout function"
          docker run --rm -v "$WORKDIR":/work -w /work \
            -e SUPABASE_ACCESS_TOKEN="$SUPABASE_ACCESS_TOKEN" \
            -e SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF" \
            $IMAGE supabase functions deploy create-stripe-checkout --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt

          echo "Deploying verify-stripe-session function"
          docker run --rm -v "$WORKDIR":/work -w /work \
            -e SUPABASE_ACCESS_TOKEN="$SUPABASE_ACCESS_TOKEN" \
            -e SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF" \
            $IMAGE supabase functions deploy verify-stripe-session --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt

          echo "Listing deployed functions"
          docker run --rm -v "$WORKDIR":/work -w /work \
            -e SUPABASE_ACCESS_TOKEN="$SUPABASE_ACCESS_TOKEN" \
            -e SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF" \
            $IMAGE supabase functions list --project-ref "$SUPABASE_PROJECT_REF" || true
