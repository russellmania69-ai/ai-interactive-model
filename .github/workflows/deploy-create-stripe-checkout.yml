name: Deploy Supabase create-stripe-checkout Function

on:
  workflow_dispatch: {}
  push:
    paths:
      - 'supabase/functions/create-stripe-checkout/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install supabase CLI
        run: |
          echo "Installing Supabase CLI via latest release (.deb)"
          ASSET_URL=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | grep '"browser_download_url":' | grep linux | grep amd64 | grep '\.deb' | head -n1 | cut -d '"' -f4)
          if [ -z "$ASSET_URL" ]; then
            echo "Could not find a linux amd64 .deb asset for Supabase CLI"; exit 1;
          fi
          echo "Downloading $ASSET_URL"
          curl -sL "$ASSET_URL" -o /tmp/supabase.deb
          sudo dpkg -i /tmp/supabase.deb

      - name: Verify supabase CLI
        run: supabase --version

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ] || [ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ] || [ -z "${{ secrets.STRIPE_SECRET_KEY }}" ]; then
            echo "Missing required secrets: SUPABASE_ACCESS_TOKEN, SUPABASE_PROJECT_REF, STRIPE_SECRET_KEY";
            exit 1;
          fi

      - name: Set STRIPE_SECRET_KEY in Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          supabase secrets set STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" --project-ref "$SUPABASE_PROJECT_REF"
          # also set alternate name for compatibility
          supabase secrets set STRIPE_SECRET="$STRIPE_SECRET_KEY" --project-ref "$SUPABASE_PROJECT_REF"

      - name: Deploy create-stripe-checkout function
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase functions deploy create-stripe-checkout --project-ref "$SUPABASE_PROJECT_REF"

      - name: List functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: supabase functions list --project-ref "$SUPABASE_PROJECT_REF"
