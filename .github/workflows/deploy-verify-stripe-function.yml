name: Deploy Supabase verify-stripe-session Function

on:
  workflow_dispatch: {}
  push:
    paths:
      - 'supabase/functions/verify-stripe-session/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node (for supabase CLI via npm)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install supabase CLI
        run: npm install -g supabase@latest

      - name: Verify supabase CLI
        run: supabase --version

      - name: Set STRIPE secret in Supabase (uses repo secrets)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ] || [ -z "$STRIPE_SECRET_KEY" ]; then
            echo "Missing required secrets. Set SUPABASE_ACCESS_TOKEN, SUPABASE_PROJECT_REF, STRIPE_SECRET_KEY in repository secrets.";
            exit 1;
          fi
          # the CLI picks up SUPABASE_ACCESS_TOKEN from env
          supabase secrets set STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" --project-ref "$SUPABASE_PROJECT_REF"

      - name: Deploy verify-stripe-session function
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase functions deploy verify-stripe-session --project-ref "$SUPABASE_PROJECT_REF"

      - name: List functions (confirmation)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: supabase functions list --project-ref "$SUPABASE_PROJECT_REF"
