name: Rotate Secrets

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Secret name to rotate'
        required: true
      method:
        description: 'backend to use: github or vault'
        required: true
        default: 'github'
      generate:
        description: 'Generate a new random secret (true/false)'
        required: false
        default: 'true'
      vault_path:
        description: 'Vault KV path (if using vault)'
        required: false

permissions:
  contents: read
  secrets: write

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node (for script runtime)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y curl ca-certificates
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update && sudo apt install -y gh

      - name: Authenticate gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "$GITHUB_TOKEN" | gh auth login --with-token

      - name: Install Vault CLI (optional)
        if: ${{ inputs.method == 'vault' }}
        run: |
          curl -sSL https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip -o vault.zip
          sudo apt-get install -y unzip
          unzip vault.zip
          sudo mv vault /usr/local/bin/

      - name: Run rotate script (GitHub)
        if: ${{ inputs.method == 'github' }}
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x ./scripts/rotate-secrets.sh
          if [ "${{ inputs.generate }}" = 'true' ]; then
            ./scripts/rotate-secrets.sh --name "${{ inputs.name }}" --generate --repo "${{ github.repository }}"
          else
            echo "ERROR: non-generate flows require passing a secret via workflow secrets; use vault or modify step." && exit 1
          fi

      - name: Run rotate script (Vault)
        if: ${{ inputs.method == 'vault' }}
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          chmod +x ./scripts/rotate-secrets.sh
          ./scripts/rotate-secrets.sh --name "${{ inputs.name }}" --generate --vault-path "${{ inputs.vault_path }}"
